// Kana map + kana parsing helpers (ES module)
export const KANA_MAP = new Map([

    ["あ","a"],["い","i"],["う","u"],["え","e"],["お","o"],
    ["か","ka"],["き","ki"],["く","ku"],["け","ke"],["こ","ko"],
    ["さ","sa"],["し","shi"],["す","su"],["せ","se"],["そ","so"],
    ["た","ta"],["ち","chi"],["つ","tsu"],["て","te"],["と","to"],
    ["な","na"],["に","ni"],["ぬ","nu"],["ね","ne"],["の","no"],
    ["は","ha"],["ひ","hi"],["ふ","fu"],["へ","he"],["ほ","ho"],
    ["ま","ma"],["み","mi"],["む","mu"],["め","me"],["も","mo"],
    ["や","ya"],["ゆ","yu"],["よ","yo"],
    ["ら","ra"],["り","ri"],["る","ru"],["れ","re"],["ろ","ro"],
    ["わ","wa"],["ゐ","wi"],["ゑ","we"],["を","o"],
    ["ん","n"],
    ["が","ga"],["ぎ","gi"],["ぐ","gu"],["げ","ge"],["ご","go"],
    ["ざ","za"],["じ","ji"],["ず","zu"],["ぜ","ze"],["ぞ","zo"],
    ["だ","da"],["ぢ","ji"],["づ","zu"],["で","de"],["ど","do"],
    ["ば","ba"],["び","bi"],["ぶ","bu"],["べ","be"],["ぼ","bo"],
    ["ぱ","pa"],["ぴ","pi"],["ぷ","pu"],["ぺ","pe"],["ぽ","po"],
    ["ぁ","a"],["ぃ","i"],["ぅ","u"],["ぇ","e"],["ぉ","o"],
    ["ゃ","ya"],["ゅ","yu"],["ょ","yo"],
    ["っ","(sokuon)"],["ゎ","wa"],["ゔ","vu"],
    ["きゃ","kya"],["きゅ","kyu"],["きょ","kyo"],
    ["ぎゃ","gya"],["ぎゅ","gyu"],["ぎょ","gyo"],
    ["しゃ","sha"],["しゅ","shu"],["しょ","sho"],
    ["じゃ","ja"],["じゅ","ju"],["じょ","jo"],
    ["ちゃ","cha"],["ちゅ","chu"],["ちょ","cho"],
    ["にゃ","nya"],["にゅ","nyu"],["にょ","nyo"],
    ["ひゃ","hya"],["ひゅ","hyu"],["ひょ","hyo"],
    ["びゃ","bya"],["びゅ","byu"],["びょ","byo"],
    ["ぴゃ","pya"],["ぴゅ","pyu"],["ぴょ","pyo"],
    ["みゃ","mya"],["みゅ","myu"],["みょ","myo"],
    ["りゃ","rya"],["りゅ","ryu"],["りょ","ryo"],
    ["てゃ","tya"],["てゅ","tyu"],["てょ","tyo"],
    ["でゃ","dya"],["でゅ","dyu"],["でょ","dyo"],
    ["ふぁ","fa"],["ふぃ","fi"],["ふぇ","fe"],["ふぉ","fo"],
    ["ゔぁ","va"],["ゔぃ","vi"],["ゔぇ","ve"],["ゔぉ","vo"],["ゔゅ","vyu"],

    ["ア","a"],["イ","i"],["ウ","u"],["エ","e"],["オ","o"],
    ["カ","ka"],["キ","ki"],["ク","ku"],["ケ","ke"],["コ","ko"],
    ["サ","sa"],["シ","shi"],["ス","su"],["セ","se"],["ソ","so"],
    ["タ","ta"],["チ","chi"],["ツ","tsu"],["テ","te"],["ト","to"],
    ["ナ","na"],["ニ","ni"],["ヌ","nu"],["ネ","ne"],["ノ","no"],
    ["ハ","ha"],["ヒ","hi"],["フ","fu"],["ヘ","he"],["ホ","ho"],
    ["マ","ma"],["ミ","mi"],["ム","mu"],["メ","me"],["モ","mo"],
    ["ヤ","ya"],["ユ","yu"],["ヨ","yo"],
    ["ラ","ra"],["リ","ri"],["ル","ru"],["レ","re"],["ロ","ro"],
    ["ワ","wa"],["ヰ","wi"],["ヱ","we"],["ヲ","o"],
    ["ン","n"],
    ["ガ","ga"],["ギ","gi"],["グ","gu"],["ゲ","ge"],["ゴ","go"],
    ["ザ","za"],["ジ","ji"],["ズ","zu"],["ゼ","ze"],["ゾ","zo"],
    ["ダ","da"],["ヂ","ji"],["ヅ","zu"],["デ","de"],["ド","do"],
    ["バ","ba"],["ビ","bi"],["ブ","bu"],["ベ","be"],["ボ","bo"],
    ["パ","pa"],["ピ","pi"],["プ","pu"],["ペ","pe"],["ポ","po"],
    ["ァ","a"],["ィ","i"],["ゥ","u"],["ェ","e"],["ォ","o"],
    ["ャ","ya"],["ュ","yu"],["ョ","yo"],
    ["ッ","(sokuon)"],["ヮ","wa"],["ー","(long)"],["ヴ","vu"],
    ["キャ","kya"],["キュ","kyu"],["キョ","kyo"],
    ["ギャ","gya"],["ギュ","gyu"],["ギョ","gyo"],
    ["シャ","sha"],["シュ","shu"],["ショ","sho"],
    ["ジャ","ja"],["ジュ","ju"],["ジョ","jo"],
    ["チャ","cha"],["チュ","chu"],["チョ","cho"],
    ["ニャ","nya"],["ニュ","nyu"],["ニョ","nyo"],
    ["ヒャ","hya"],["ヒュ","hyu"],["ヒョ","hyo"],
    ["ビャ","bya"],["ビュ","byu"],["ビョ","byo"],
    ["ピャ","pya"],["ピュ","pyu"],["ピョ","pyo"],
    ["ミャ","mya"],["ミュ","myu"],["ミョ","myo"],
    ["リャ","rya"],["リュ","ryu"],["リョ","ryo"],
    ["ファ","fa"],["フィ","fi"],["フェ","fe"],["フォ","fo"],
    ["フャ","fya"],["フュ","fyu"],["フョ","fyo"],
    ["ティ","ti"],["トゥ","tu"],["チェ","che"],["シェ","she"],["ジェ","je"],
    ["ディ","di"],["ドゥ","du"],
    ["ウィ","wi"],["ウェ","we"],["ウォ","wo"],
    ["スィ","si"],["ズィ","zi"],
    ["ツァ","tsa"],["ツィ","tsi"],["ツェ","tse"],["ツォ","tso"],
    ["テュ","tyu"],["デュ","dyu"],
    ["ヴァ","va"],["ヴィ","vi"],["ヴェ","ve"],["ヴォ","vo"],["ヴュ","vyu"],
    ["クァ","kwa"],["クィ","kwi"],["クェ","kwe"],["クォ","kwo"],
    ["グァ","gwa"],["グィ","gwi"],["グェ","gwe"],["グォ","gwo"],

]);

export function leadingConsonant(romaji) {
  const m = (romaji || "").match(/^(ch|sh|ky|gy|ny|hy|by|py|my|ry|ts|j|f|v|t|d|k|g|s|z|n|h|b|p|m|r|w|y)/);
  return m ? m[1] : "";
}

export function kanaToUnits(kana) {
  const units = [];
  for (let i = 0; i < (kana || "").length; i++) {
    const two = kana.slice(i, i + 2);
    if (KANA_MAP.has(two)) { units.push(two); i++; continue; }
    units.push(kana.slice(i, i + 1));
  }
  return units;
}

export function unitsToRomaji(units) {
  let out = "";
  for (let i = 0; i < (units || []).length; i++) {
    const u = units[i];
    const v = KANA_MAP.get(u);
    if (!v) continue;

    if (v === "(sokuon)") {
      const next = units[i + 1];
      const nextRomaji = next ? (KANA_MAP.get(next) || "") : "";
      const c = leadingConsonant(nextRomaji);
      out += c ? c : "";
      continue;
    }
    if (v === "(long)") {
      const prev = out[out.length - 1] || "";
      if ("aeiou".includes(prev)) out += prev;
      continue;
    }
    out += v;
  }
  return out;
}